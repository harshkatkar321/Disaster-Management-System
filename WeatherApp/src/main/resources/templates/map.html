<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Weather & Disaster Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
        }
        #side-panel {
            width: 300px;
            background: #f4f4f4;
            padding: 15px;
            overflow-y: auto;
            height: 100vh;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #map {
            flex: 1;
            height: 100vh;
        }
        .legend {
            background: white;
            padding: 10px;
            font-size: 14px;
            position: absolute;
            bottom: 30px;
            left: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .disaster-entry {
            margin-bottom: 10px;
            padding: 5px;
            background: #fff;
            border-left: 4px solid #999;
        }
    </style>
</head>
<body>

<div id="side-panel">
    <h3>Weather Info</h3>
    <p><strong>City:</strong> [[${entity.cityName}]], [[${entity.country}]]</p>
    <p><strong>Temperature:</strong> [[${entity.temperature} ?: 0]] Â°C</p>
    <p><strong>Humidity:</strong> [[${entity.humidity} ?: 0]]%</p>
    <p><strong>Wind Speed:</strong> [[${entity.windSpeed} ?: 0]] km/h</p>
    <p><strong>Time:</strong> [[${entity.fetchTime}]]</p>

    <hr>

    <h3>Disasters</h3>
    <div id="disaster-list">
        <p>Loading disasters...</p>
    </div>
</div>

<div id="map"></div>

<div class="legend">
    <b>Legend:</b><br>
    ğŸŸ¢ Weather<br>
    ğŸ”¥ Wildfire<br>
    ğŸŒŠ Flood<br>
    ğŸŒªï¸ Storm<br>
    ğŸŒ‹ Volcano<br>
    ğŸ“ Other
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    const lat = [[${entity.latitude} ?: 0]];
    const lon = [[${entity.longitude} ?: 0]];
    const city = '[[${entity.cityName}]]';
    const country = '[[${entity.country}]]';
    const temperature = [[${entity.temperature} ?: 0]];
    const humidity = [[${entity.humidity} ?: 0]];
    const windSpeed = [[${entity.windSpeed} ?: 0]];
    const fetchTime = '[[${entity.fetchTime}]]';

    const map = L.map('map').setView([lat, lon], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© OpenStreetMap contributors',
    }).addTo(map);

    // Weather Marker
    const weatherPopup = `
        <b>${city}, ${country}</b><br/>
        ğŸŒ¡ï¸ Temp: ${temperature} Â°C<br/>
        ğŸ’§ Humidity: ${humidity}%<br/>
        ğŸŒ¬ï¸ Wind: ${windSpeed} km/h<br/>
        ğŸ•’ Time: ${fetchTime}
    `;
    L.marker([lat, lon], {
        icon: L.divIcon({ className: '', html: 'ğŸŸ¢', iconSize: [20, 20] })
    }).addTo(map).bindPopup(weatherPopup).openPopup();

    // Load disasters
    fetch('/api/disasters')
      .then(res => res.json())
      .then(data => {
        const disasterList = document.getElementById('disaster-list');
        disasterList.innerHTML = ''; // clear loading msg

        data.forEach(d => {
          let emoji = 'ğŸ“';
          const cat = d.category.toLowerCase();
          if (cat.includes("fire")) emoji = 'ğŸ”¥';
          else if (cat.includes("flood")) emoji = 'ğŸŒŠ';
          else if (cat.includes("storm") || cat.includes("cyclone")) emoji = 'ğŸŒªï¸';
          else if (cat.includes("volcano")) emoji = 'ğŸŒ‹';

          const popupText = `
            <b>${d.title}</b><br/>
            Category: ${d.category}<br/>
            Date: ${d.date}
          `;
          L.marker([d.latitude, d.longitude], {
              icon: L.divIcon({ className: '', html: emoji, iconSize: [20, 20] })
          }).addTo(map).bindPopup(popupText);

          // Add to sidebar
          const div = document.createElement('div');
          div.className = 'disaster-entry';
          div.innerHTML = `
            <b>${emoji} ${d.title}</b><br/>
            <i>${d.category}</i><br/>
            <small>${d.date}</small>
          `;
          disasterList.appendChild(div);
        });
      });
</script>

</body>
</html>
